<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ورود به سامانه مالیاتی</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet"
        type="text/css" />
    <!-- jQuery (required for persian-datepicker) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Persian Date Picker -->
    <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css" />
    <script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
    <style>
        :root {
            --color-bg: #f5f5f5;
            --color-surface: #ffffff;
            --color-text: #1a1a1a;
            --color-text-secondary: #666666;
            --color-border: #e5e5e5;
            --color-border-focus: #1a1a1a;
            --color-primary: #1a1a1a;
            --color-primary-hover: #333333;
            --color-error: #dc2626;
            --color-error-bg: #fef2f2;
            --color-success: #16a34a;
            --color-success-bg: #f0fdf4;
            --color-loading: #2563eb;
            --color-loading-bg: #eff6ff;
            --radius-lg: 16px;
            --radius-md: 8px;
            --radius-sm: 6px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Vazirmatn', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--color-bg);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 24px;
            line-height: 1.6;
        }

        .container {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 32px;
            max-width: 420px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        /* Status Banner */
        .status {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 14px 24px;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            display: none;
            animation: slideDown 0.25s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-100%);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status.loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: var(--color-loading-bg);
            color: var(--color-loading);
            border-bottom: 1px solid #dbeafe;
        }

        .status.success {
            display: block;
            background: var(--color-success-bg);
            color: var(--color-success);
            border-bottom: 1px solid #bbf7d0;
        }

        .status.error {
            display: block;
            background: var(--color-error-bg);
            color: var(--color-error);
            border-bottom: 1px solid #fecaca;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(37, 99, 235, 0.2);
            border-radius: 50%;
            border-top-color: var(--color-loading);
            animation: spin 0.7s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 32px;
            padding-top: 8px;
        }

        .header h1 {
            color: var(--color-text);
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            color: var(--color-text-secondary);
            font-size: 14px;
            font-weight: 400;
        }

        /* Form Groups */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--color-text);
            font-weight: 500;
            font-size: 13px;
        }

        .form-group input {
            width: 100%;
            height: 48px;
            padding: 0 16px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 15px;
            color: var(--color-text);
            background: var(--color-surface);
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
            direction: ltr;
            text-align: left;
        }

        .form-group input::placeholder {
            color: #999;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--color-border-focus);
            box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.06);
        }

        .form-group .hint {
            color: var(--color-text-secondary);
            font-size: 12px;
            margin-top: 8px;
        }

        /* Captcha Container */
        .captcha-container {
            background: #fafafa;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
            padding: 20px;
            margin-bottom: 24px;
        }

        .captcha-container label {
            display: block;
            margin-bottom: 12px;
            color: var(--color-text);
            font-weight: 500;
            font-size: 13px;
            text-align: center;
        }

        .captcha-image-wrapper {
            background: var(--color-surface);
            border-radius: var(--radius-sm);
            padding: 16px;
            display: flex;
            justify-content: center;
            margin-bottom: 16px;
            border: 1px solid var(--color-border);
        }

        #captchaImage {
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: 4px;
        }

        .captcha-placeholder {
            width: 200px;
            height: 50px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-secondary);
            font-size: 13px;
            border-radius: 4px;
        }

        .captcha-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: stretch;
        }

        .captcha-input-wrapper input {
            flex: 1;
            height: 48px;
            padding: 0 16px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 15px;
            color: var(--color-text);
            background: var(--color-surface);
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
            direction: ltr;
            text-align: center;
            letter-spacing: 2px;
        }

        .captcha-input-wrapper input::placeholder {
            color: #999;
            letter-spacing: normal;
        }

        .captcha-input-wrapper input:focus {
            outline: none;
            border-color: var(--color-border-focus);
            box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.06);
        }

        /* Refresh Button (Secondary) */
        .refresh-btn {
            height: 48px;
            padding: 0 20px;
            background: var(--color-surface);
            color: var(--color-text-secondary);
            border: 1px solid #ddd;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .refresh-btn:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        .refresh-btn:active {
            background: #eee;
        }

        .captcha-info {
            margin-top: 12px;
            padding: 10px 12px;
            background: var(--color-surface);
            border-radius: var(--radius-sm);
            font-size: 11px;
            color: var(--color-text-secondary);
            text-align: center;
            border: 1px solid var(--color-border);
        }

        .captcha-info strong {
            color: var(--color-text);
            font-weight: 500;
        }

        /* Select Dropdown */
        .form-group select {
            width: 100%;
            height: 48px;
            padding: 0 16px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 15px;
            color: var(--color-text);
            background: var(--color-surface);
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 16px center;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .form-group select:focus {
            outline: none;
            border-color: var(--color-border-focus);
            box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.06);
        }

        .form-group select:invalid {
            color: #999;
        }

        /* Primary Button */
        .btn-primary {
            width: 100%;
            height: 48px;
            background: var(--color-primary);
            color: var(--color-surface);
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.15s ease, transform 0.1s ease;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Delete Registration Section */
        .delete-registration-card {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: var(--radius-md);
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .delete-registration-card .warning-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .delete-registration-card .warning-title {
            color: #991b1b;
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 8px;
        }

        .delete-registration-card .warning-text {
            color: #dc2626;
            font-size: 13px;
            margin-bottom: 16px;
            line-height: 1.6;
        }

        .btn-delete {
            width: 100%;
            height: 44px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.15s ease, transform 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-delete:hover {
            background: #b91c1c;
        }

        .btn-delete:active {
            transform: scale(0.98);
        }

        .btn-delete:disabled {
            background: #f87171;
            cursor: not-allowed;
            transform: none;
        }

        /* OTP Input Container */
        .otp-container {
            display: flex;
            justify-content: center;
            gap: 12px;
            direction: ltr;
            margin-top: 8px;
        }

        .otp-input {
            width: 52px;
            height: 56px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 24px;
            font-weight: 600;
            color: var(--color-text);
            background: var(--color-surface);
            text-align: center;
            line-height: 56px;
            padding: 0;
            vertical-align: middle;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .otp-input:focus {
            outline: none;
            border-color: var(--color-border-focus);
            box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.08);
        }

        .otp-input.filled {
            border-color: var(--color-border-focus);
            background: #fafafa;
        }

        .otp-input.error {
            border-color: var(--color-error);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        /* Progress Tracker Container */
        .progress-tracker {
            margin-top: 24px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            background: #fafafa;
            overflow: hidden;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            cursor: pointer;
            user-select: none;
        }

        .progress-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text);
        }

        .progress-toggle {
            font-size: 12px;
            color: var(--color-text-secondary);
            transition: transform 0.2s;
        }

        .progress-tracker.collapsed .progress-toggle {
            transform: rotate(-90deg);
        }

        .progress-tracker.collapsed .progress-steps {
            display: none;
        }

        .progress-steps {
            padding: 12px;
        }

        /* Individual Step */
        .step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            margin-bottom: 4px;
            background: var(--color-surface);
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .step:last-child {
            margin-bottom: 0;
        }

        .step[data-status="pending"] {
            opacity: 0.5;
        }

        .step[data-status="active"] {
            border-color: var(--color-loading);
            background: var(--color-loading-bg);
        }

        .step[data-status="completed"] {
            border-color: var(--color-success);
            background: var(--color-success-bg);
        }

        .step[data-status="error"] {
            border-color: var(--color-error);
            background: var(--color-error-bg);
        }

        /* Step Indicator (number circle) */
        .step-indicator {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            background: var(--color-border);
            color: var(--color-text-secondary);
            flex-shrink: 0;
        }

        .step[data-status="active"] .step-indicator {
            background: var(--color-loading);
            color: white;
        }

        .step[data-status="completed"] .step-indicator {
            background: var(--color-success);
            color: white;
        }

        .step[data-status="error"] .step-indicator {
            background: var(--color-error);
            color: white;
        }

        /* Step Content */
        .step-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .step-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--color-text);
        }

        .step-time {
            font-size: 11px;
            color: var(--color-text-secondary);
            direction: ltr;
            text-align: right;
        }

        /* Step Status Icon */
        .step-status {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step-status .check {
            color: var(--color-success);
            font-size: 16px;
        }

        .step-status .error-icon {
            color: var(--color-error);
            font-size: 16px;
        }

        .step-status .spinner-small {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(37, 99, 235, 0.2);
            border-radius: 50%;
            border-top-color: var(--color-loading);
            animation: spin 0.7s linear infinite;
        }

        /* Error Log */
        .step-error {
            margin: -4px 12px 8px 52px;
            padding: 8px 12px;
            background: var(--color-error-bg);
            border-radius: var(--radius-sm);
            border: 1px solid #fecaca;
        }

        .step-error .error-text {
            font-size: 11px;
            color: var(--color-error);
            direction: ltr;
            display: block;
            word-break: break-word;
        }

        /* Divider */
        .divider {
            height: 1px;
            background: var(--color-border);
            margin: 24px 0;
        }

        /* Help Panel (Warning) */
        .help-panel {
            background: #fffbeb;
            border: 1px solid #fbbf24;
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 20px;
        }

        .help-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .help-header h3 {
            color: #92400e;
            font-size: 16px;
            margin: 0;
        }

        .help-icon {
            font-size: 24px;
        }

        .help-content p {
            color: #78350f;
            margin-bottom: 16px;
            line-height: 1.7;
        }

        .help-content h4 {
            color: #92400e;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .help-content ol {
            padding-right: 20px;
            margin-bottom: 20px;
        }

        .help-content li {
            color: #78350f;
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .help-content a {
            color: #d97706;
            text-decoration: underline;
        }

        .help-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            background: #f59e0b;
            color: white;
            padding: 10px 20px;
            border-radius: var(--radius-md);
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            display: inline-block;
        }

        .btn-secondary:hover {
            background: #d97706;
        }

        .btn-text {
            background: transparent;
            border: none;
            color: #92400e;
            cursor: pointer;
            font-size: 14px;
            padding: 10px;
            font-family: inherit;
        }

        .btn-text:hover {
            text-decoration: underline;
        }

        /* Partner/Account Card Styles */
        .card-list {
            margin-bottom: 20px;
        }

        .partner-card,
        .account-card {
            background: #fafafa;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text);
        }

        .btn-remove {
            background: var(--color-error-bg);
            color: var(--color-error);
            border: 1px solid #fecaca;
            border-radius: var(--radius-sm);
            padding: 6px 12px;
            font-size: 12px;
            font-family: inherit;
            cursor: pointer;
        }

        .btn-remove:hover {
            background: #fee2e2;
        }

        .card-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .card-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .card-row .form-group.small {
            flex: 0 0 100px;
        }

        .btn-add {
            width: 100%;
            padding: 12px;
            background: var(--color-success-bg);
            color: var(--color-success);
            border: 1px dashed var(--color-success);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-family: inherit;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .btn-add:hover {
            background: #dcfce7;
        }

        .share-total {
            text-align: center;
            padding: 10px;
            background: var(--color-loading-bg);
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
            font-size: 14px;
            color: var(--color-loading);
        }

        .share-total.error {
            background: var(--color-error-bg);
            color: var(--color-error);
        }

        .share-total.success {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        .iban-input {
            direction: ltr !important;
            text-align: left !important;
            font-family: monospace;
            letter-spacing: 1px;
        }

        .skip-section {
            background: #f0fdf4;
            border: 1px solid #86efac;
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 20px;
            text-align: center;
        }

        .skip-section p {
            color: #166534;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .btn-skip {
            background: var(--color-success);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: 10px 24px;
            font-size: 14px;
            font-family: inherit;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-skip:hover {
            background: #15803d;
        }

        /* Responsive */
        @media (max-width: 480px) {
            body {
                padding: 16px;
            }

            .container {
                padding: 24px;
            }

            .header h1 {
                font-size: 20px;
            }

            .captcha-input-wrapper {
                flex-direction: column;
            }

            .refresh-btn {
                width: 100%;
                justify-content: center;
            }

            .otp-container {
                gap: 8px;
            }

            .otp-input {
                width: 48px;
                height: 52px;
                font-size: 22px;
            }

            .step {
                padding: 8px 10px;
            }

            .step-indicator {
                width: 24px;
                height: 24px;
                font-size: 12px;
            }

            .step-label {
                font-size: 12px;
            }

            .step-error {
                margin-left: 46px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="status" id="status" role="alert" aria-live="polite" aria-atomic="true"></div>

        <div class="header">
            <h1>ورود به سامانه مالیاتی</h1>
            <p>لطفاً اطلاعات خود را وارد کنید</p>
        </div>

        <form id="loginForm">
            <div class="form-group">
                <label for="mobile">شماره موبایل</label>
                <input type="tel" value="09364646448" id="mobile" name="mobile" placeholder="09123456789"
                    pattern="09[0-9]{9}" autocomplete="tel" required>
            </div>

            <div class="captcha-container">
                <label>کد امنیتی</label>
                <div class="captcha-image-wrapper">
                    <img id="captchaImage" style="display: none;" alt="کد امنیتی">
                    <div id="captchaPlaceholder" class="captcha-placeholder">
                        در حال بارگذاری...
                    </div>
                </div>

                <div class="captcha-input-wrapper">
                    <input type="text" id="captchaCode" name="captchaCode" placeholder="کد را وارد کنید" maxlength="6"
                        autocomplete="off" required>
                    <button type="button" class="refresh-btn" id="refreshCaptcha">
                        <span>تازه‌سازی</span>
                    </button>
                </div>

            </div>

            <button type="submit" class="btn-primary" id="loginBtn">ارسال کد تأیید</button>
        </form>

        <form id="otpForm" style="display: none;">
            <div class="form-group">
                <label id="otpLabel">کد تأیید</label>
                <div class="otp-container" role="group" aria-labelledby="otpLabel">
                    <input type="text" class="otp-input" data-index="0" maxlength="1" inputmode="numeric"
                        pattern="[0-9]" autocomplete="one-time-code" aria-label="رقم اول" required>
                    <input type="text" class="otp-input" data-index="1" maxlength="1" inputmode="numeric"
                        pattern="[0-9]" aria-label="رقم دوم" required>
                    <input type="text" class="otp-input" data-index="2" maxlength="1" inputmode="numeric"
                        pattern="[0-9]" aria-label="رقم سوم" required>
                    <input type="text" class="otp-input" data-index="3" maxlength="1" inputmode="numeric"
                        pattern="[0-9]" aria-label="رقم چهارم" required>
                    <input type="text" class="otp-input" data-index="4" maxlength="1" inputmode="numeric"
                        pattern="[0-9]" aria-label="رقم پنجم" required>
                </div>
                <p class="hint">
                    کد تأیید به شماره <strong id="sentMobile"></strong> ارسال شد
                </p>
            </div>

            <button type="submit" class="btn-primary" id="otpBtn">ورود به سامانه</button>
        </form>

        <div id="dashboardSection" style="display: none;">
            <button type="button" class="btn-primary" id="dashboardBtn">دسترسی به داشبورد</button>
        </div>

        <div id="taxFileSection" style="display: none;">
            <!-- Help panel for incomplete registrations error -->
            <div id="incompleteRegHelp" class="help-panel" style="display: none;">
                <div class="help-header">
                    <span class="help-icon">⚠️</span>
                    <h3>پرونده‌های ناتمام یافت شد</h3>
                </div>
                <div class="help-content">
                    <p>شما پرونده‌های مالیاتی ناتمامی دارید که باید قبل از ایجاد پرونده جدید تکمیل یا غیرفعال شوند.</p>

                    <h4>مراحل رفع مشکل:</h4>
                    <ol>
                        <li>وارد سامانه <a href="https://my.tax.gov.ir" target="_blank">my.tax.gov.ir</a> شوید</li>
                        <li>به بخش «پرونده‌های مالیاتی» یا «ثبت‌نام‌های من» بروید</li>
                        <li>پرونده‌های ناتمام (قبل از گام ۴) را پیدا کنید</li>
                        <li>هر پرونده را یا <strong>تکمیل</strong> کنید یا <strong>غیرفعال</strong> کنید</li>
                        <li>پس از اتمام، به اینجا برگردید و دوباره تلاش کنید</li>
                    </ol>

                    <div class="help-actions">
                        <a href="https://my.tax.gov.ir" target="_blank" class="btn-secondary">
                            رفتن به سامانه مالیاتی
                        </a>
                        <button type="button" class="btn-text" onclick="hideIncompleteRegistrationHelp()">
                            بستن راهنما
                        </button>
                    </div>
                </div>
            </div>

            <form id="taxFileForm">
                <div class="form-group">
                    <label for="postalCode">کد پستی</label>
                    <input type="text" id="postalCode" name="postalCode" placeholder="کد پستی ۱۰ رقمی" maxlength="10"
                        inputmode="numeric" pattern="[0-9]{10}" required style="direction: ltr; text-align: left;">
                </div>

                <div class="form-group">
                    <label for="businessName">نام کسب و کار</label>
                    <input type="text" id="businessName" name="businessName"
                        placeholder="نام کسب و کار خود را وارد کنید" required
                        style="direction: rtl; text-align: right;">
                </div>

                <div class="form-group">
                    <label for="regType">نوع ثبت‌نام</label>
                    <select id="regType" name="regType" required>
                        <option value="" disabled selected>انتخاب کنید...</option>
                        <option value="Single">حقیقی (فردی)</option>
                        <option value="Company">حقوقی (شرکت)</option>
                    </select>
                </div>

                <button type="submit" class="btn-primary" id="taxFileBtn">شروع پرونده مالیاتی</button>
            </form>

            <!-- Delete Registration Section - dynamically populated by fetchIncompleteRegistrations() -->
            <div id="deleteRegistrationSection" class="delete-registration-card" style="display: none;">
                <!-- Content is dynamically populated -->
            </div>
        </div>

        <div id="basicInfoSection" style="display: none;">
            <div class="header" style="margin-bottom: 24px;">
                <h1>اطلاعات پایه ثبت‌نام</h1>
                <p>لطفاً اطلاعات کسب‌وکار خود را تکمیل کنید</p>
            </div>
            <form id="basicInfoForm">
                <div class="form-group">
                    <label for="registrationReason">دلیل ثبت‌نام <span
                            style="color: var(--color-error);">*</span></label>
                    <select id="registrationReason" name="registrationReason" required>
                        <option value="" disabled selected>انتخاب کنید...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="activityType">نوع فعالیت <span style="color: var(--color-error);">*</span></label>
                    <select id="activityType" name="activityType" required>
                        <option value="" disabled selected>انتخاب کنید...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="startDate">تاریخ شروع فعالیت <span style="color: var(--color-error);">*</span></label>
                    <input type="text" id="startDate" name="startDate" placeholder="برای انتخاب تاریخ کلیک کنید"
                        required readonly style="direction: ltr; text-align: left; cursor: pointer;">
                    <p class="hint">روی فیلد کلیک کنید تا تقویم شمسی باز شود</p>
                </div>

                <div class="form-group">
                    <label for="unitTitle">عنوان واحد <span style="color: var(--color-error);">*</span></label>
                    <input type="text" id="unitTitle" name="unitTitle" placeholder="نام کسب‌وکار یا درگاه پرداخت"
                        required style="direction: rtl; text-align: right;">
                </div>

                <div class="form-group">
                    <label for="eightCategoryJob">مشاغل هشتگانه <span
                            style="color: var(--color-error);">*</span></label>
                    <select id="eightCategoryJob" name="eightCategoryJob" required>
                        <option value="" disabled selected>انتخاب کنید...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="individualJob">مشاغل انفرادی <span style="color: var(--color-error);">*</span></label>
                    <select id="individualJob" name="individualJob" required>
                        <option value="" disabled selected>انتخاب کنید...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="professionalGuild">مجامع صنفی <span style="color: var(--color-error);">*</span></label>
                    <select id="professionalGuild" name="professionalGuild" required>
                        <option value="" disabled selected>انتخاب کنید...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="professionalAssembly">مجامع صنفی (انتخاب) <span
                            style="color: var(--color-error);">*</span></label>
                    <select id="professionalAssembly" name="professionalAssembly" required>
                        <option value="" disabled selected>انتخاب کنید...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="guildUnion">اتحادیه صنفی <span style="color: var(--color-error);">*</span></label>
                    <select id="guildUnion" name="guildUnion" required>
                        <option value="" disabled selected>انتخاب کنید...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="businessLicense">پروانه کسب <span style="color: var(--color-error);">*</span></label>
                    <select id="businessLicense" name="businessLicense" required>
                        <option value="" disabled selected>انتخاب کنید...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="ownershipType">نوع مالکیت <span style="color: var(--color-error);">*</span></label>
                    <select id="ownershipType" name="ownershipType" required>
                        <option value="" disabled selected>انتخاب کنید...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="website">پایگاه اینترنتی (اختیاری)</label>
                    <input type="text" id="website" name="website" placeholder="https://example.com"
                        style="direction: ltr; text-align: left;">
                    <p class="hint">آدرس وبسایت کسب‌وکار شما (اختیاری)</p>
                </div>

                <button type="submit" class="btn-primary" id="basicInfoBtn">ثبت اطلاعات پایه</button>
            </form>
        </div>

        <!-- Step 3: Partners Section (شرکا و اعضا) -->
        <div id="partnersSection" style="display: none;">
            <div class="header" style="margin-bottom: 24px;">
                <h1>شرکا و اعضا</h1>
                <p>اطلاعات شرکا و سهامداران کسب‌وکار</p>
            </div>

            <!-- Skip option for individual businesses -->
            <div class="skip-section" id="skipPartnersSection" style="display: none;">
                <p>برای کسب‌وکارهای فردی (حقیقی)، این مرحله اختیاری است.</p>
                <button type="button" class="btn-skip" onclick="skipToAccounts()">رد شدن به مرحله بعد</button>
            </div>

            <div id="partnersFormContainer">
                <div class="card-list" id="partnersList">
                    <!-- Partner cards will be added here dynamically -->
                </div>

                <button type="button" class="btn-add" onclick="addPartner()">
                    + افزودن شریک جدید
                </button>

                <div class="share-total" id="shareTotal">
                    مجموع سهام: <strong id="shareTotalValue">۰</strong>٪ (باید ۱۰۰٪ باشد)
                </div>

                <button type="button" class="btn-primary" id="partnersBtn" onclick="submitPartners()">
                    ثبت شرکا و ادامه
                </button>
            </div>
        </div>

        <!-- Step 4: Bank Accounts Section (حساب‌های بانکی) -->
        <div id="accountsSection" style="display: none;">
            <div class="header" style="margin-bottom: 24px;">
                <h1>حساب‌های بانکی</h1>
                <p>حساب‌های بانکی مرتبط با کسب‌وکار</p>
            </div>

            <div id="accountsFormContainer">
                <div class="card-list" id="accountsList">
                    <!-- Account cards will be added here dynamically -->
                </div>

                <button type="button" class="btn-add" onclick="addAccount()">
                    + افزودن حساب بانکی جدید
                </button>

                <button type="button" class="btn-primary" id="accountsBtn" onclick="submitBankAccounts()">
                    ثبت حساب‌ها و اتمام
                </button>
            </div>
        </div>

        <!-- Progress Tracker -->
        <div class="progress-tracker" id="progressTracker">
            <div class="progress-header" id="progressHeader">
                <span class="progress-title">وضعیت پیشرفت</span>
                <span class="progress-toggle" id="progressToggle">▼</span>
            </div>
            <div class="progress-steps" id="progressSteps">
                <!-- Steps generated dynamically by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        let captchaData = null;
        let currentStep = 0;
        let userMobile = '';

        // Progress Step Definitions (post-login steps only)
        const STEPS = [
            { id: 1, label: 'دسترسی به داشبورد' },
            { id: 2, label: 'شروع پرونده مالیاتی' },
            { id: 3, label: 'ثبت اطلاعات پایه' },
            { id: 4, label: 'شرکا و اعضا' },
            { id: 5, label: 'حساب‌های بانکی' }
        ];

        // Registration type (Single/Company) - set when tax file is started
        let registrationType = 'Single';
        // Partner counter for unique IDs
        let partnerCounter = 0;
        // Account counter for unique IDs
        let accountCounter = 0;
        // Registration ID pending deletion (when there's an incomplete registration)
        let pendingDeleteRegistrationId = null;

        // Step State Manager
        const stepState = {
            steps: {},
            init() {
                STEPS.forEach(s => {
                    this.steps[s.id] = { status: 'pending', time: null, error: null };
                });
                this.render();
            },
            setActive(stepId) {
                this.steps[stepId].status = 'active';
                this.steps[stepId].time = new Date();
                this.steps[stepId].error = null;
                this.render();
            },
            setCompleted(stepId) {
                this.steps[stepId].status = 'completed';
                this.steps[stepId].time = new Date();
                this.steps[stepId].error = null;
                this.render();
            },
            setError(stepId, errorMsg) {
                this.steps[stepId].status = 'error';
                this.steps[stepId].error = errorMsg;
                this.render();
            },
            formatTime(date) {
                if (!date) return '--:--';
                return date.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            },
            toPersianNum(num) {
                const persianDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
                return String(num).replace(/\d/g, d => persianDigits[d]);
            },
            render() {
                const container = document.getElementById('progressSteps');
                if (!container) return;

                container.innerHTML = STEPS.map(step => {
                    const state = this.steps[step.id];
                    const statusIcon = state.status === 'completed' ? '<span class="check">✓</span>' :
                        state.status === 'active' ? '<span class="spinner-small"></span>' :
                            state.status === 'error' ? '<span class="error-icon">✕</span>' : '';

                    return `
                        <div class="step" data-step="${step.id}" data-status="${state.status}">
                            <div class="step-indicator">${this.toPersianNum(step.id)}</div>
                            <div class="step-content">
                                <span class="step-label">${step.label}</span>
                                <span class="step-time">${this.formatTime(state.time)}</span>
                            </div>
                            <div class="step-status">${statusIcon}</div>
                        </div>
                        ${state.error ? `<div class="step-error"><span class="error-text">${state.error}</span></div>` : ''}
                    `;
                }).join('');
            }
        };

        async function startRedirectTracker() {
            currentStep = 1;
            showStatus('در حال اتصال به سرور...', 'loading');

            try {
                const response = await fetch('/api/start-tracker', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success && data.captcha) {
                    captchaData = data.captcha;
                    displayCaptcha(data.captcha);
                    currentStep = 2;
                    showStatus('آماده ورود', 'success');
                    setTimeout(() => hideStatus(), 2000);
                } else {
                    showStatus('خطا: ' + (data.error || 'دریافت کپچا ناموفق'), 'error');
                }
            } catch (error) {
                showStatus('خطا در اتصال: ' + error.message, 'error');
            }
        }

        function displayCaptcha(captcha) {
            const img = document.getElementById('captchaImage');
            const placeholder = document.getElementById('captchaPlaceholder');

            if (captcha.imageData) {
                img.src = captcha.imageData;
                img.style.display = 'block';
                placeholder.style.display = 'none';
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.className = 'status ' + type;

            if (type === 'loading') {
                status.innerHTML = '<span class="spinner"></span><span>' + message + '</span>';
                // Set aria-busy on active buttons during loading (Issue 18)
                document.querySelectorAll('.btn-primary:not(:disabled)').forEach(btn => {
                    btn.setAttribute('aria-busy', 'true');
                });
            } else {
                status.textContent = message;
                // Clear aria-busy when not loading
                document.querySelectorAll('.btn-primary').forEach(btn => {
                    btn.removeAttribute('aria-busy');
                });
            }
        }

        function hideStatus() {
            const status = document.getElementById('status');
            status.className = 'status';
        }

        // OTP Input Management
        function initOtpInputs() {
            const otpInputs = document.querySelectorAll('.otp-input');

            otpInputs.forEach((input, index) => {
                // Input: validate digit, auto-focus next, auto-submit on 5th digit
                input.addEventListener('input', (e) => {
                    if (!/^\d$/.test(e.target.value)) {
                        e.target.value = '';
                        input.classList.remove('filled');
                        return;
                    }
                    input.classList.add('filled');
                    if (index < 4) {
                        otpInputs[index + 1].focus();
                    } else if (getOtpValue().length === 5) {
                        document.getElementById('otpForm').requestSubmit();
                    }
                });

                // Backspace: go to previous input
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        otpInputs[index - 1].focus();
                        otpInputs[index - 1].value = '';
                        otpInputs[index - 1].classList.remove('filled');
                    }
                });

                // Paste: distribute digits across inputs + auto-submit if complete
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const digits = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 5);
                    digits.split('').forEach((d, i) => {
                        if (otpInputs[i]) {
                            otpInputs[i].value = d;
                            otpInputs[i].classList.add('filled');
                        }
                    });
                    otpInputs[Math.min(digits.length, 4)].focus();
                    if (digits.length === 5) {
                        document.getElementById('otpForm').requestSubmit();
                    }
                });

                // Select all on focus
                input.addEventListener('focus', (e) => {
                    e.target.select();
                });
            });
        }

        function getOtpValue() {
            return Array.from(document.querySelectorAll('.otp-input'))
                .map(input => input.value).join('');
        }

        function clearOtpInputs() {
            document.querySelectorAll('.otp-input').forEach(input => {
                input.value = '';
                input.classList.remove('filled', 'error');
            });
            document.querySelector('.otp-input').focus();
        }

        function setOtpError() {
            document.querySelectorAll('.otp-input').forEach(i => i.classList.add('error'));
            setTimeout(() => {
                document.querySelectorAll('.otp-input').forEach(i => i.classList.remove('error'));
            }, 2000);
        }

        // Show help panel for incomplete registrations
        function showIncompleteRegistrationHelp() {
            document.getElementById('incompleteRegHelp').style.display = 'block';
        }

        // Hide help panel for incomplete registrations
        function hideIncompleteRegistrationHelp() {
            document.getElementById('incompleteRegHelp').style.display = 'none';
        }

        // Check if error is about incomplete registrations
        function isIncompleteRegistrationError(errorMsg) {
            if (!errorMsg) return false;
            // Check for various patterns that indicate incomplete registration
            const patterns = [
                'تکمیل ثبت نام های حقیقی فعال',
                'تکمیل ثبت نام',
                'ثبت نام های حقیقی فعال',
                'قبل از گام 4',
                'ابتدا نسبت به تکمیل'
            ];
            return patterns.some(pattern => errorMsg.includes(pattern));
        }

        // Fetch incomplete registrations from dashboard
        async function fetchIncompleteRegistrations() {
            showStatus('در حال دریافت پرونده‌های ناتمام...', 'loading');
            const deleteSection = document.getElementById('deleteRegistrationSection');
            deleteSection.innerHTML = '<div class="warning-icon">⏳</div><div class="warning-title">در حال بارگذاری...</div>';
            deleteSection.style.display = 'block';

            try {
                const response = await fetch('/api/incomplete-registrations');
                const data = await response.json();

                console.log('Incomplete registrations response:', data);

                if (data.success && data.data && data.data.length > 0) {
                    showIncompleteRegistrationsList(data.data);
                    showStatus('پرونده‌های ناتمام یافت شد', 'info');
                } else if (data.success && (!data.data || data.data.length === 0)) {
                    deleteSection.innerHTML = `
                        <div class="warning-icon">ℹ️</div>
                        <div class="warning-title">پرونده ناتمامی یافت نشد</div>
                        <div class="warning-text">ممکن است پرونده قبلاً حذف شده باشد. لطفاً دوباره تلاش کنید.</div>
                    `;
                    showStatus('پرونده ناتمامی یافت نشد', 'info');
                } else {
                    deleteSection.innerHTML = `
                        <div class="warning-icon">❌</div>
                        <div class="warning-title">خطا در دریافت پرونده‌ها</div>
                        <div class="warning-text">${data.error || 'خطای نامشخص'}</div>
                    `;
                    showStatus('خطا: ' + (data.error || 'خطا در دریافت پرونده‌ها'), 'error');
                }
            } catch (error) {
                console.error('Error fetching incomplete registrations:', error);
                deleteSection.innerHTML = `
                    <div class="warning-icon">❌</div>
                    <div class="warning-title">خطا در اتصال</div>
                    <div class="warning-text">${error.message}</div>
                `;
                showStatus('خطا: ' + error.message, 'error');
            }
        }

        // Show list of incomplete registrations with delete buttons
        function showIncompleteRegistrationsList(registrations) {
            const container = document.getElementById('deleteRegistrationSection');
            let html = '<div class="warning-icon">⚠️</div>';
            html += '<div class="warning-title">پرونده‌های ثبت‌نام ناتمام</div>';
            html += '<div class="warning-text">برای ایجاد پرونده جدید، ابتدا پرونده‌های ناتمام را حذف کنید:</div>';
            html += '<div class="incomplete-list" style="margin-top: 16px;">';

            registrations.forEach(reg => {
                const displayName = reg.businessName || 'بدون نام';
                const displayStatus = reg.status || 'نامشخص';
                html += `
                    <div class="incomplete-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px;">
                        <span class="reg-info" style="flex: 1;">
                            <strong>${displayName}</strong>
                            <span style="color: #666; margin-right: 8px;">(${displayStatus})</span>
                        </span>
                        <button class="btn-delete" onclick="deleteRegistration('${reg.uuid}')" style="padding: 8px 16px;">
                            🗑️ حذف
                        </button>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
            container.style.display = 'block';
        }

        // Hide delete registration section
        function hideDeleteRegistrationSection() {
            document.getElementById('deleteRegistrationSection').style.display = 'none';
            pendingDeleteRegistrationId = null;
        }

        // Delete registration function
        async function deleteRegistration(registrationId) {
            if (!registrationId) {
                showStatus('خطا: شناسه ثبت‌نام یافت نشد', 'error');
                return;
            }

            // Confirmation dialog
            if (!confirm('آیا از حذف این درخواست ثبت‌نام اطمینان دارید؟\n\nاین عمل قابل بازگشت نیست.')) {
                return;
            }

            // Find and disable the button that was clicked
            const buttons = document.querySelectorAll('.btn-delete');
            buttons.forEach(btn => btn.disabled = true);
            showStatus('در حال حذف درخواست ثبت‌نام...', 'loading');

            try {
                const response = await fetch('/api/delete-registration', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        registrationId: registrationId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showStatus(data.message || 'درخواست با موفقیت حذف شد', 'success');
                    hideDeleteRegistrationSection();
                    hideIncompleteRegistrationHelp();
                    // Re-enable the tax file form button
                    document.getElementById('taxFileBtn').disabled = false;
                    setTimeout(() => {
                        showStatus('اکنون می‌توانید پرونده جدید ایجاد کنید', 'success');
                    }, 1500);
                } else {
                    showStatus('خطا: ' + (data.error || 'حذف ناموفق'), 'error');
                    // Re-enable buttons on error
                    const buttons = document.querySelectorAll('.btn-delete');
                    buttons.forEach(btn => btn.disabled = false);
                }
            } catch (error) {
                showStatus('خطا: ' + error.message, 'error');
                // Re-enable buttons on error
                const buttons = document.querySelectorAll('.btn-delete');
                buttons.forEach(btn => btn.disabled = false);
            }
        }

        // Initialize Persian date picker for Jalali calendar
        function initPersianDatePicker() {
            if (typeof $ !== 'undefined' && $.fn.persianDatepicker) {
                $('#startDate').persianDatepicker({
                    format: 'YYYY/MM/DD',
                    persianDigit: false,
                    autoClose: true,
                    initialValue: false,
                    toolbox: {
                        calendarSwitch: { enabled: false },
                        todayButton: { enabled: true, text: { fa: 'امروز' } },
                        submitButton: { enabled: true, text: { fa: 'تایید' } }
                    },
                    dayPicker: { enabled: true },
                    monthPicker: { enabled: true },
                    yearPicker: { enabled: true },
                    responsive: true
                });
            }
        }

        document.getElementById('refreshCaptcha').addEventListener('click', async () => {
            showStatus('در حال تازه‌سازی...', 'loading');

            try {
                const response = await fetch('/api/refresh-captcha', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success && data.captcha) {
                    captchaData = data.captcha;
                    displayCaptcha(data.captcha);
                    document.getElementById('captchaCode').value = '';
                    showStatus('کپچا تازه شد', 'success');
                    setTimeout(() => hideStatus(), 1500);
                } else {
                    showStatus('خطا در تازه‌سازی', 'error');
                }
            } catch (error) {
                showStatus('خطا: ' + error.message, 'error');
            }
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const mobile = document.getElementById('mobile').value;
            const captchaCode = document.getElementById('captchaCode').value;
            const loginBtn = document.getElementById('loginBtn');

            if (!captchaData) {
                showStatus('لطفاً منتظر بارگذاری کپچا بمانید', 'error');
                return;
            }

            // Mobile validation (Issue 20)
            if (!/^09\d{9}$/.test(mobile)) {
                showStatus('شماره موبایل نامعتبر است', 'error');
                return;
            }

            // Captcha validation - 5 digits (Issue 21)
            if (!captchaCode || captchaCode.length !== 5 || !/^\d+$/.test(captchaCode)) {
                showStatus('کد امنیتی باید ۵ رقم باشد', 'error');
                return;
            }

            loginBtn.disabled = true;
            showStatus('در حال ارسال کد...', 'loading');

            try {
                const response = await fetch('/api/send-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mobile: mobile,
                        captchaCode: captchaCode,
                        captchaKey: captchaData.key,
                        csrfToken: captchaData.csrfToken
                    })
                });

                const data = await response.json();

                if (data.success) {
                    userMobile = mobile;
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('otpForm').style.display = 'block';
                    document.getElementById('sentMobile').textContent = mobile;
                    showStatus('کد تأیید ارسال شد', 'success');
                    setTimeout(() => hideStatus(), 2500);
                    document.querySelector('.otp-input').focus();
                } else {
                    showStatus('خطا: ' + (data.error || 'ارسال ناموفق'), 'error');
                    loginBtn.disabled = false;
                }
            } catch (error) {
                showStatus('خطا: ' + error.message, 'error');
                loginBtn.disabled = false;
            }
        });

        document.getElementById('otpForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const otpCode = getOtpValue();
            const otpBtn = document.getElementById('otpBtn');

            // OTP validation - 5 digits only (Issue 22)
            if (!otpCode || otpCode.length !== 5 || !/^\d+$/.test(otpCode)) {
                showStatus('کد تأیید باید ۵ رقم باشد', 'error');
                setOtpError();
                return;
            }

            if (!captchaData || !userMobile) {
                showStatus('خطا: لطفاً صفحه را رفرش کنید', 'error');
                return;
            }

            otpBtn.disabled = true;
            showStatus('در حال تأیید...', 'loading');

            try {
                const response = await fetch('/api/verify-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mobile: userMobile,
                        otpCode: otpCode,
                        csrfToken: captchaData.csrfToken
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showStatus('ورود موفق!', 'success');
                    document.getElementById('otpForm').style.display = 'none';
                    document.getElementById('dashboardSection').style.display = 'block';
                } else {
                    showStatus('خطا: ' + (data.error || 'تأیید ناموفق'), 'error');
                    setOtpError();
                    clearOtpInputs();
                    otpBtn.disabled = false;
                }
            } catch (error) {
                showStatus('خطا: ' + error.message, 'error');
                setOtpError();
                otpBtn.disabled = false;
            }
        });

        document.getElementById('dashboardBtn').addEventListener('click', async () => {
            const dashboardBtn = document.getElementById('dashboardBtn');
            dashboardBtn.disabled = true;
            showStatus('در حال دسترسی...', 'loading');
            stepState.setActive(1);

            try {
                const response = await fetch('/api/access-dashboard', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    stepState.setCompleted(1);
                    showStatus('دسترسی موفق!', 'success');
                    document.getElementById('dashboardSection').style.display = 'none';
                    document.getElementById('taxFileSection').style.display = 'block';
                } else {
                    stepState.setError(1, data.error || 'دسترسی ناموفق');
                    showStatus('خطا: ' + (data.error || 'دسترسی ناموفق'), 'error');
                    dashboardBtn.disabled = false;
                }
            } catch (error) {
                stepState.setError(1, error.message);
                showStatus('خطا: ' + error.message, 'error');
                dashboardBtn.disabled = false;
            }
        });

        document.getElementById('taxFileForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const postalCode = document.getElementById('postalCode').value;
            const businessName = document.getElementById('businessName').value;
            const regType = document.getElementById('regType').value;
            const taxFileBtn = document.getElementById('taxFileBtn');

            taxFileBtn.disabled = true;
            showStatus('در حال شروع پرونده...', 'loading');
            stepState.setActive(2);

            try {
                const response = await fetch('/api/start-tax-file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        postalCode: postalCode,
                        businessName: businessName,
                        type: regType
                    })
                });

                const data = await response.json();

                if (data.success) {
                    stepState.setCompleted(2);
                    showStatus('پرونده با موفقیت شروع شد', 'success');
                    // Store registration type for later use
                    registrationType = regType;
                    // Hide help panel if visible
                    hideIncompleteRegistrationHelp();
                    // Hide tax file section and show basic info section
                    document.getElementById('taxFileSection').style.display = 'none';
                    document.getElementById('basicInfoSection').style.display = 'block';
                    // Pre-fill unit title with business name
                    document.getElementById('unitTitle').value = businessName;
                    // Load form options and initialize date picker
                    loadFormOptions();
                    initPersianDatePicker();
                } else {
                    // Error message can come from data.error, data.message, or data.data.error
                    const errorMsg = data.error || data.message || (data.data && data.data.error) || 'شروع ناموفق';
                    console.log('Tax file error response:', data);
                    console.log('Error message:', errorMsg);
                    stepState.setError(2, errorMsg);
                    showStatus('خطا: ' + errorMsg, 'error');
                    // Check if this is the incomplete registration error
                    const isIncomplete = isIncompleteRegistrationError(errorMsg);
                    console.log('Is incomplete registration error:', isIncomplete);
                    if (isIncomplete) {
                        showIncompleteRegistrationHelp();
                        // Auto-fetch incomplete registrations from dashboard
                        fetchIncompleteRegistrations();
                    }
                    taxFileBtn.disabled = false;
                }
            } catch (error) {
                stepState.setError(2, error.message);
                showStatus('خطا: ' + error.message, 'error');
                taxFileBtn.disabled = false;
            }
        });

        // Form options cache
        let formOptions = null;

        // Load form options from server
        async function loadFormOptions() {
            if (formOptions) {
                populateDropdowns(formOptions);
                return;
            }

            try {
                const response = await fetch('/api/form-options');
                const data = await response.json();

                if (data.success && data.data) {
                    formOptions = data.data;
                    populateDropdowns(formOptions);
                } else {
                    console.error('Failed to load form options:', data.error);
                }
            } catch (error) {
                console.error('Error loading form options:', error);
            }
        }

        // Populate dropdown with options
        function populateDropdown(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select || !options) return;

            // Keep the first placeholder option
            const placeholder = select.querySelector('option[disabled]');
            select.innerHTML = '';
            if (placeholder) select.appendChild(placeholder);

            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.labelFa || opt.label;
                select.appendChild(option);
            });
        }

        // Populate all dropdowns with options
        function populateDropdowns(opts) {
            populateDropdown('registrationReason', opts.RegistrationReasons);
            populateDropdown('activityType', opts.ActivityTypes);
            populateDropdown('eightCategoryJob', opts.EightCategoryJobs);
            populateDropdown('individualJob', opts.IndividualJobs);
            populateDropdown('professionalGuild', opts.ProfessionalGuilds);
            populateDropdown('professionalAssembly', opts.ProfessionalAssemblies);
            populateDropdown('guildUnion', opts.GuildUnions);
            populateDropdown('businessLicense', opts.BusinessLicenses);
            populateDropdown('ownershipType', opts.OwnershipTypes);
        }

        // Basic info form submission
        document.getElementById('basicInfoForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const basicInfoBtn = document.getElementById('basicInfoBtn');
            basicInfoBtn.disabled = true;
            showStatus('در حال ثبت اطلاعات پایه...', 'loading');
            stepState.setActive(3);

            const formData = {
                registrationReason: document.getElementById('registrationReason').value,
                activityType: document.getElementById('activityType').value,
                startDate: persianToEnglishDigits(document.getElementById('startDate').value),
                unitTitle: document.getElementById('unitTitle').value,
                eightCategoryJob: document.getElementById('eightCategoryJob').value,
                individualJob: document.getElementById('individualJob').value,
                professionalGuild: document.getElementById('professionalGuild').value,
                professionalAssembly: document.getElementById('professionalAssembly').value,
                guildUnion: document.getElementById('guildUnion').value,
                businessLicense: document.getElementById('businessLicense').value,
                ownershipType: document.getElementById('ownershipType').value,
                website: document.getElementById('website').value
            };

            try {
                const response = await fetch('/api/submit-basic-info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    stepState.setCompleted(3);
                    showStatus(data.message || 'اطلاعات پایه با موفقیت ثبت شد', 'success');
                    // Hide basic info section and show partners section
                    document.getElementById('basicInfoSection').style.display = 'none';
                    document.getElementById('partnersSection').style.display = 'block';
                    // Show skip option for individual businesses
                    if (registrationType === 'Single') {
                        document.getElementById('skipPartnersSection').style.display = 'block';
                    }
                    // Add first partner card
                    addPartner();
                } else {
                    stepState.setError(3, data.error || 'ثبت ناموفق');
                    showStatus('خطا: ' + (data.error || 'ثبت ناموفق'), 'error');
                    basicInfoBtn.disabled = false;
                }
            } catch (error) {
                stepState.setError(3, error.message);
                showStatus('خطا: ' + error.message, 'error');
                basicInfoBtn.disabled = false;
            }
        });

        // =====================
        // PARTNERS MANAGEMENT (Step 4)
        // =====================

        // Convert number to Persian numerals
        function toPersianNum(num) {
            const persianDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            return String(num).replace(/\d/g, d => persianDigits[d]);
        }

        // Convert Persian digits to English/Arabic digits
        function persianToEnglishDigits(str) {
            if (!str) return str;
            const persianDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            const englishDigits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
            let result = String(str);
            for (let i = 0; i < 10; i++) {
                result = result.replace(new RegExp(persianDigits[i], 'g'), englishDigits[i]);
            }
            return result;
        }

        // Add a new partner card
        function addPartner() {
            partnerCounter++;
            const partnerId = partnerCounter;
            const partnersList = document.getElementById('partnersList');

            const card = document.createElement('div');
            card.className = 'partner-card';
            card.id = `partner-${partnerId}`;
            card.innerHTML = `
                <div class="card-header">
                    <span class="card-title">شریک ${toPersianNum(partnerId)}</span>
                    <button type="button" class="btn-remove" onclick="removePartner(${partnerId})">حذف</button>
                </div>
                <div class="card-row">
                    <div class="form-group">
                        <label>کد ملی <span style="color: var(--color-error);">*</span></label>
                        <input type="text" id="partner-nationalId-${partnerId}"
                               placeholder="کد ملی ۱۰ رقمی" maxlength="10"
                               inputmode="numeric" pattern="[0-9]{10}"
                               style="direction: ltr; text-align: left;"
                               onchange="validateNationalId(this)">
                    </div>
                    <div class="form-group small">
                        <label>سهم (٪) <span style="color: var(--color-error);">*</span></label>
                        <input type="number" id="partner-share-${partnerId}"
                               placeholder="۰" min="1" max="100"
                               style="direction: ltr; text-align: center;"
                               onchange="updateShareTotal()">
                    </div>
                </div>
                <div class="card-row">
                    <div class="form-group">
                        <label>نام و نام خانوادگی <span style="color: var(--color-error);">*</span></label>
                        <input type="text" id="partner-fullName-${partnerId}"
                               placeholder="نام کامل شریک"
                               style="direction: rtl; text-align: right;">
                    </div>
                </div>
                <div class="card-row">
                    <div class="form-group">
                        <label>نقش <span style="color: var(--color-error);">*</span></label>
                        <select id="partner-role-${partnerId}">
                            <option value="" disabled selected>انتخاب کنید...</option>
                            <option value="manager">مدیر</option>
                            <option value="partner">شریک</option>
                            <option value="shareholder">سهامدار</option>
                            <option value="board_member">عضو هیئت مدیره</option>
                        </select>
                    </div>
                </div>
                <div class="card-row">
                    <div class="form-group">
                        <label>کد پستی <span style="color: var(--color-error);">*</span></label>
                        <input type="text" id="partner-postalCode-${partnerId}"
                               placeholder="کد پستی ۱۰ رقمی" maxlength="10"
                               inputmode="numeric" pattern="[0-9]{10}"
                               style="direction: ltr; text-align: left;">
                    </div>
                    <div class="form-group">
                        <label>تلفن همراه <span style="color: var(--color-error);">*</span></label>
                        <input type="text" id="partner-mobile-${partnerId}"
                               placeholder="۰۹۱۲۳۴۵۶۷۸۹" maxlength="11"
                               inputmode="numeric" pattern="09[0-9]{9}"
                               style="direction: ltr; text-align: left;">
                    </div>
                </div>
            `;

            partnersList.appendChild(card);
            updateShareTotal();
        }

        // Remove a partner card
        function removePartner(partnerId) {
            const card = document.getElementById(`partner-${partnerId}`);
            if (card) {
                card.remove();
                updateShareTotal();
            }
        }

        // Validate national ID (10 digits)
        function validateNationalId(input) {
            const value = input.value.replace(/\D/g, '');
            input.value = value;
            if (value.length !== 10) {
                input.style.borderColor = 'var(--color-error)';
            } else {
                input.style.borderColor = 'var(--color-border)';
            }
        }

        // Update share total display
        function updateShareTotal() {
            const cards = document.querySelectorAll('.partner-card');
            let total = 0;

            cards.forEach(card => {
                const shareInput = card.querySelector('input[type="number"]');
                if (shareInput && shareInput.value) {
                    total += parseInt(shareInput.value, 10) || 0;
                }
            });

            const totalElement = document.getElementById('shareTotalValue');
            const containerElement = document.getElementById('shareTotal');

            totalElement.textContent = toPersianNum(total);

            // Update styling based on total
            containerElement.classList.remove('error', 'success');
            if (total === 100) {
                containerElement.classList.add('success');
            } else if (total > 100) {
                containerElement.classList.add('error');
            }
        }

        // Skip partners section (for individual businesses)
        function skipToAccounts() {
            stepState.setCompleted(4);
            document.getElementById('partnersSection').style.display = 'none';
            document.getElementById('accountsSection').style.display = 'block';
            // Add first account card
            addAccount();
        }

        // Collect partner data from cards
        function collectPartnerData() {
            const cards = document.querySelectorAll('.partner-card');
            const partners = [];

            cards.forEach(card => {
                const id = card.id.replace('partner-', '');
                const nationalId = document.getElementById(`partner-nationalId-${id}`).value;
                const fullName = document.getElementById(`partner-fullName-${id}`).value;
                const sharePercent = parseInt(document.getElementById(`partner-share-${id}`).value, 10) || 0;
                const role = document.getElementById(`partner-role-${id}`).value;
                const postalCode = document.getElementById(`partner-postalCode-${id}`).value;
                const mobile = document.getElementById(`partner-mobile-${id}`).value;

                partners.push({ nationalId, fullName, sharePercent, role, postalCode, mobile });
            });

            return partners;
        }

        // Submit partners
        async function submitPartners() {
            const partners = collectPartnerData();

            // Validate partners
            if (partners.length === 0) {
                showStatus('لطفاً حداقل یک شریک اضافه کنید', 'error');
                return;
            }

            // Validate share total
            const totalShare = partners.reduce((sum, p) => sum + p.sharePercent, 0);
            if (totalShare !== 100) {
                showStatus('مجموع سهام باید ۱۰۰٪ باشد', 'error');
                return;
            }

            // Validate each partner
            for (let i = 0; i < partners.length; i++) {
                const p = partners[i];
                if (!p.nationalId || p.nationalId.length !== 10) {
                    showStatus(`کد ملی شریک ${toPersianNum(i + 1)} نامعتبر است`, 'error');
                    return;
                }
                if (!p.fullName) {
                    showStatus(`نام شریک ${toPersianNum(i + 1)} را وارد کنید`, 'error');
                    return;
                }
                if (!p.role) {
                    showStatus(`نقش شریک ${toPersianNum(i + 1)} را انتخاب کنید`, 'error');
                    return;
                }
                if (!p.postalCode || p.postalCode.length !== 10) {
                    showStatus(`کد پستی شریک ${toPersianNum(i + 1)} نامعتبر است (۱۰ رقم)`, 'error');
                    return;
                }
                if (!p.mobile || !p.mobile.match(/^09[0-9]{9}$/)) {
                    showStatus(`تلفن همراه شریک ${toPersianNum(i + 1)} نامعتبر است (مثال: ۰۹۱۲۳۴۵۶۷۸۹)`, 'error');
                    return;
                }
            }

            const partnersBtn = document.getElementById('partnersBtn');
            partnersBtn.disabled = true;
            showStatus('در حال ثبت شرکا...', 'loading');
            stepState.setActive(4);

            try {
                const response = await fetch('/api/submit-partners', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ partners: partners })
                });

                const data = await response.json();

                if (data.success) {
                    stepState.setCompleted(4);
                    showStatus(data.message || 'شرکا با موفقیت ثبت شدند', 'success');
                    // Hide partners section and show accounts section
                    document.getElementById('partnersSection').style.display = 'none';
                    document.getElementById('accountsSection').style.display = 'block';
                    // Add first account card
                    addAccount();
                } else {
                    stepState.setError(4, data.error || 'ثبت ناموفق');
                    showStatus('خطا: ' + (data.error || 'ثبت ناموفق'), 'error');
                    partnersBtn.disabled = false;
                }
            } catch (error) {
                stepState.setError(4, error.message);
                showStatus('خطا: ' + error.message, 'error');
                partnersBtn.disabled = false;
            }
        }

        // =====================
        // BANK ACCOUNTS MANAGEMENT (Step 5)
        // =====================

        // Add a new account card
        function addAccount() {
            accountCounter++;
            const accountId = accountCounter;
            const accountsList = document.getElementById('accountsList');

            const card = document.createElement('div');
            card.className = 'account-card';
            card.id = `account-${accountId}`;
            card.innerHTML = `
                <div class="card-header">
                    <span class="card-title">حساب ${toPersianNum(accountId)}</span>
                    <button type="button" class="btn-remove" onclick="removeAccount(${accountId})">حذف</button>
                </div>
                <div class="card-row">
                    <div class="form-group">
                        <label>شماره شبا <span style="color: var(--color-error);">*</span></label>
                        <input type="text" id="account-iban-${accountId}"
                               class="iban-input"
                               placeholder="۲۴ رقم بدون IR"
                               maxlength="24" inputmode="numeric"
                               onchange="validateIban(this)">
                        <p class="hint">شماره شبا بدون حروف IR - فقط ۲۴ رقم</p>
                    </div>
                </div>
                <div class="card-row">
                    <div class="form-group">
                        <label>تاریخ شروع استفاده <span style="color: var(--color-error);">*</span></label>
                        <input type="text" id="account-startDate-${accountId}"
                               class="account-date-picker"
                               placeholder="برای انتخاب تاریخ کلیک کنید"
                               readonly style="direction: ltr; text-align: left; cursor: pointer;">
                    </div>
                </div>
            `;

            accountsList.appendChild(card);

            // Initialize Persian date picker for this account
            if (typeof $ !== 'undefined' && $.fn.persianDatepicker) {
                $(`#account-startDate-${accountId}`).persianDatepicker({
                    format: 'YYYY/MM/DD',
                    persianDigit: false,
                    autoClose: true,
                    initialValue: false,
                    toolbox: {
                        calendarSwitch: { enabled: false },
                        todayButton: { enabled: true, text: { fa: 'امروز' } },
                        submitButton: { enabled: true, text: { fa: 'تایید' } }
                    },
                    dayPicker: { enabled: true },
                    monthPicker: { enabled: true },
                    yearPicker: { enabled: true },
                    responsive: true
                });
            }
        }

        // Remove an account card
        function removeAccount(accountId) {
            const card = document.getElementById(`account-${accountId}`);
            if (card) {
                card.remove();
            }
        }

        // Validate IBAN (24 digits)
        function validateIban(input) {
            const value = input.value.replace(/\D/g, '');
            input.value = value;
            if (value.length !== 24) {
                input.style.borderColor = 'var(--color-error)';
            } else {
                input.style.borderColor = 'var(--color-border)';
            }
        }

        // Collect account data from cards
        function collectAccountData() {
            const cards = document.querySelectorAll('.account-card');
            const accounts = [];

            cards.forEach(card => {
                const id = card.id.replace('account-', '');
                const iban = document.getElementById(`account-iban-${id}`).value;
                const startDate = persianToEnglishDigits(document.getElementById(`account-startDate-${id}`).value);

                accounts.push({ iban, startDate });
            });

            return accounts;
        }

        // Submit bank accounts
        async function submitBankAccounts() {
            const accounts = collectAccountData();

            // Validate accounts
            if (accounts.length === 0) {
                showStatus('لطفاً حداقل یک حساب بانکی اضافه کنید', 'error');
                return;
            }

            // Validate each account
            for (let i = 0; i < accounts.length; i++) {
                const a = accounts[i];
                if (!a.iban || a.iban.length !== 24) {
                    showStatus(`شماره شبا حساب ${toPersianNum(i + 1)} نامعتبر است (باید ۲۴ رقم باشد)`, 'error');
                    return;
                }
                if (!a.startDate) {
                    showStatus(`تاریخ شروع حساب ${toPersianNum(i + 1)} را انتخاب کنید`, 'error');
                    return;
                }
            }

            const accountsBtn = document.getElementById('accountsBtn');
            accountsBtn.disabled = true;
            showStatus('در حال ثبت حساب‌های بانکی...', 'loading');
            stepState.setActive(5);

            try {
                const response = await fetch('/api/submit-bank-accounts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accounts: accounts })
                });

                const data = await response.json();

                if (data.success) {
                    stepState.setCompleted(5);
                    showStatus(data.message || 'ثبت‌نام با موفقیت تکمیل شد!', 'success');
                    // Show completion message
                    document.getElementById('accountsFormContainer').innerHTML = `
                        <div style="text-align: center; padding: 40px 20px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">✅</div>
                            <h2 style="color: var(--color-success); margin-bottom: 8px;">ثبت‌نام تکمیل شد</h2>
                            <p style="color: var(--color-text-secondary);">پرونده مالیاتی شما با موفقیت ایجاد شد.</p>
                            <p style="color: var(--color-text-secondary); margin-top: 12px;">
                                می‌توانید از طریق سامانه my.tax.gov.ir وضعیت پرونده را پیگیری کنید.
                            </p>
                        </div>
                    `;
                } else {
                    stepState.setError(5, data.error || 'ثبت ناموفق');
                    showStatus('خطا: ' + (data.error || 'ثبت ناموفق'), 'error');
                    accountsBtn.disabled = false;
                }
            } catch (error) {
                stepState.setError(5, error.message);
                showStatus('خطا: ' + error.message, 'error');
                accountsBtn.disabled = false;
            }
        }

        // Toggle progress tracker collapse
        document.getElementById('progressHeader').addEventListener('click', () => {
            document.getElementById('progressTracker').classList.toggle('collapsed');
        });

        window.addEventListener('load', () => {
            stepState.init();
            startRedirectTracker();
            initOtpInputs();
        });
    </script>
</body>

</html>